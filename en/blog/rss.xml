<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Lab240 Blog</title>
        <link>https://lab240.github.io/en/blog</link>
        <description>Lab240 Blog</description>
        <lastBuildDate>Wed, 25 Oct 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Napi P. Первый взгляд.]]></title>
            <link>https://lab240.github.io/en/blog/napi-p-first-vew</link>
            <guid>https://lab240.github.io/en/blog/napi-p-first-vew</guid>
            <pubDate>Wed, 25 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Первый взгляд на процессорный модуль Napi C.]]></description>
            <content:encoded><![CDATA[<p>Первый взгляд на процессорный модуль Napi C.</p><p><img loading="lazy" src="/en/assets/images/napi0-1-cfd93ccea197be44d322ed939ca72e3e.png" width="567" height="257" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="краткая-предыстория">Краткая предыстория<a href="#краткая-предыстория" class="hash-link" aria-label="Direct link to Краткая предыстория" title="Direct link to Краткая предыстория">​</a></h2><p>Сначала была Napi. По сути это одноплатный компьютер с GPIO и интерфейсами на удобных "ножках". Преимущества такого подхода очевидны - все сложные скоростные интерфейсы уже подготовлены и не требуют реализации на основной плате. Однако, это накладывает ограничения на форм фактор оконечного "девайса" - надо планировать разъемы Ethernet\USB в определенном месте. Хотя у нас есть уже несколько изделий на NAPI, мы хотели обойти эти ограничения. </p><p>Эту NAPI мы маркируем Napi C (Classic)</p><p><img loading="lazy" src="/en/assets/images/napi1-2ddde1dfaa0aa0001197f7bbc1fe00d0.png" width="219" height="178" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="штырьки-вместо-разъемов">Штырьки вместо разъемов<a href="#штырьки-вместо-разъемов" class="hash-link" aria-label="Direct link to Штырьки вместо разъемов" title="Direct link to Штырьки вместо разъемов">​</a></h3><p>Идея наша довольно банальна - заменить Ethernet\USB штырьками на тех же местах, минимально изменяя плату. </p><p>Так у нас появилась Napi P (Pins).</p><p><img loading="lazy" src="/en/assets/images/napi-p-84e678fb7504394d3dc6d6ec49a7a7b9.png" width="651" height="323" class="img_ev3q"></p><p><img loading="lazy" src="/en/assets/images/napi-p1-646e8d81fa6975dec92156e497482797.png" width="350" height="183" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="что-это-дает">Что это дает<a href="#что-это-дает" class="hash-link" aria-label="Direct link to Что это дает" title="Direct link to Что это дает">​</a></h2><p>Мы разработали плату с слотом PCI-E на основе Napi P. На этой плате
располагаются разъемы Ethernet и USB в удобных для нас местах.</p><p><img loading="lazy" src="/en/assets/images/frontcompactlte1-8cdb5af741f42f30cc20b81239086b04.png" width="548" height="367" class="img_ev3q"></p><p>Это позволяет более гибко располагать элементы на плате (нам надо расположить разъемы на одной стороне, потому что мы планируем использовать плату в электрощитах).</p>]]></content:encoded>
            <category>napi</category>
            <category>napi-c</category>
            <category>napi-p</category>
        </item>
        <item>
            <title><![CDATA[Сборщик-компакт. Первый взгляд.]]></title>
            <link>https://lab240.github.io/en/blog/froncontrol-compact-first-view</link>
            <guid>https://lab240.github.io/en/blog/froncontrol-compact-first-view</guid>
            <pubDate>Fri, 20 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Первый взгляд на сигнальный образец Сборщик-Компакт.]]></description>
            <content:encoded><![CDATA[<p>Первый взгляд на сигнальный образец Сборщик-Компакт. </p><p><img loading="lazy" src="/en/assets/images/cl0-a309e03013386cab512c27bd8571cac2.png" width="732" height="535" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="краткая-предыстория">Краткая предыстория<a href="#краткая-предыстория" class="hash-link" aria-label="Direct link to Краткая предыстория" title="Direct link to Краткая предыстория">​</a></h2><p>Сначала была Napi</p><p><img loading="lazy" src="/en/assets/images/napi1-2ddde1dfaa0aa0001197f7bbc1fe00d0.png" width="219" height="178" class="img_ev3q"></p><p>Потом пришла идея "Надо сделать очень компактный промышленный одноплатник". </p><p>Откуда такие идеи ? Потому что реально нужно "воткнуть" в шкаф на DIN или прикрутить к стене и забыть. У нас уже
есть платформа, для котрой не надо охлаждения (NAPI), теперь надо превратить ее в законченный продукт.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="классическая-плата">Классическая плата<a href="#классическая-плата" class="hash-link" aria-label="Direct link to Классическая плата" title="Direct link to Классическая плата">​</a></h2><p>В классическом случае мы паяем NAPI ножками вниз от процессора, но тогда девайс, куда она вставляется получается "высокий" (как минимум на высоту ножек). </p><p><img loading="lazy" src="/en/assets/images/hand1-76d14aa769a768f3b1b85bee9ee21347.png" width="380" height="199" class="img_ev3q"></p><p>Как правило, такая высота всех устраивает, но мы хотим сделать совсем компактно..</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="как-сделать-тонко-">Как сделать "тонко" ?<a href="#как-сделать-тонко-" class="hash-link" aria-label="Direct link to Как сделать &quot;тонко&quot; ?" title="Direct link to Как сделать &quot;тонко&quot; ?">​</a></h2><p>Воспользуемся тем, что ножки NAPI можно паять на любую сторону. </p><p>Если мы перевернем ножки, мы не сможем "вставить" ножки в слоты, потому что нам "мешает" Ethernet и USB. Так вот наша незамысловатая
идея состоит в том, чтобы вырезать в несущей плате места под разъемы, чтобы плата максимально "утопла" и сам девайс стал максимально "плоским".</p><p><img loading="lazy" src="/en/assets/images/cli5-bb83107f76a644f8c7719266256644e0.png" width="478" height="624" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="корпусирование">Корпусирование<a href="#корпусирование" class="hash-link" aria-label="Direct link to Корпусирование" title="Direct link to Корпусирование">​</a></h2><p>Корпус разработали тоже мы. Он должен быть максимально простым, прочным, компактным.</p><p><img loading="lazy" src="/en/assets/images/cl6-db5ae12878d7f6af49a6d7270d1c3d77.png" width="452" height="310" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="воплощение">Воплощение<a href="#воплощение" class="hash-link" aria-label="Direct link to Воплощение" title="Direct link to Воплощение">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="плата-с-модулем">Плата с модулем<a href="#плата-с-модулем" class="hash-link" aria-label="Direct link to Плата с модулем" title="Direct link to Плата с модулем">​</a></h3><p><img loading="lazy" src="/en/assets/images/cli1-db3e8196451e9b5b66b5ab4feb810cc1.png" width="433" height="233" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="корпус">Корпус<a href="#корпус" class="hash-link" aria-label="Direct link to Корпус" title="Direct link to Корпус">​</a></h3><p><img loading="lazy" src="/en/assets/images/cl7-a97249981edfc722f92a21a457cf1e90.png" width="412" height="490" class="img_ev3q"></p><p>Получилось довольно компактно, сравним с пачкой сигарет.</p><p><img loading="lazy" src="/en/assets/images/cl8-9e74082a49269cb68d8895130a18510f.png" width="630" height="310" class="img_ev3q"></p><p>И в добрых руках инженера</p><p><img loading="lazy" src="/en/assets/images/cli9-e95ad0e63a93cf32b9643ec1a73e2ed8.png" width="455" height="407" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="итоги">Итоги<a href="#итоги" class="hash-link" aria-label="Direct link to Итоги" title="Direct link to Итоги">​</a></h3><p><img loading="lazy" src="/en/assets/images/cli6-c73c4858afb07f1d9734cd32734e1cc4.png" width="495" height="509" class="img_ev3q"></p><p>В закрытом виде</p><p><img loading="lazy" src="/en/assets/images/cl2-6150d1e21c242d1bab48a3144892df20.png" width="483" height="220" class="img_ev3q"></p><p>И, наконец, в электро-щите !</p><p><img loading="lazy" src="/en/assets/images/cli8-ff6017bbe362662e6f53258424a0a57c.png" width="414" height="506" class="img_ev3q"></p><p>Приступаем к тестированию и "доведению" до изящества.</p>]]></content:encoded>
            <category>napi</category>
            <category>frontcontrol</category>
            <category>сборщик</category>
            <category>сборщик-компакт</category>
        </item>
        <item>
            <title><![CDATA[Кейс с NAPI (сборщик-компакт)]]></title>
            <link>https://lab240.github.io/en/blog/elemy</link>
            <guid>https://lab240.github.io/en/blog/elemy</guid>
            <pubDate>Sun, 10 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Вышла статья про кейс применения нашего NAPI (сборщик-компакт), в качестве логгер-системы (или  самописца) для систем управления питанием Elemy.]]></description>
            <content:encoded><![CDATA[<p>Вышла статья про кейс применения нашего NAPI (сборщик-компакт), в качестве логгер-системы (или  самописца) для систем управления питанием Elemy.</p><p><a href="https://napiworld.ru/blog/dmn-elemy/" target="_blank" rel="noopener noreferrer">Читать на сайте napiworld.ru</a></p>]]></content:encoded>
            <category>napi</category>
            <category>frontcontrol</category>
        </item>
        <item>
            <title><![CDATA[Статистика по процессору LS1046a]]></title>
            <link>https://lab240.github.io/en/blog/ls1046a-cpu-chart</link>
            <guid>https://lab240.github.io/en/blog/ls1046a-cpu-chart</guid>
            <pubDate>Sun, 27 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Всем привет! В этот раз я немного расскажу про то, как мы организовали процесс сбора данных о частоте и температуре процессора LS1046a без использования дополнительного программного обеспечения на базе сборки Yocto. Мы расскажем о том, как собрали данные при помощи своего велосипеда bash-скрипта, чтобы дополнительно не нагружать систему и как визуализировали их с использованием нашего небольшого веб-сервиса.]]></description>
            <content:encoded><![CDATA[<div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAACCAIAAADuA9qHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAASUlEQVQImQE+AMH/AGE1O0sxNXhYUpNrYVg9V7TAtomqs16nuYbN0bLm6QAdDxosGSlFPk1NVGhzhZSSr7ZHgKBXr8Gl4uWx7/E6AB2eLSCG3gAAAABJRU5ErkJggg==&quot;)"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="480" height="121"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/en/assets/ideal-img/header.bc05ba5.480.png" srcset="/en/assets/ideal-img/header.bc05ba5.480.png 480w,/en/assets/ideal-img/header.9957762.664.png 664w,/en/assets/ideal-img/header.ef38812.847.png 847w,/en/assets/ideal-img/header.cbdb671.1022.png 1022w" width="480" height="121"></noscript></div><p>Всем привет! В этот раз я немного расскажу про то, как мы организовали процесс сбора данных о частоте и температуре процессора LS1046a без использования дополнительного программного обеспечения на базе сборки Yocto. Мы расскажем о том, как собрали данные при помощи <del>своего велосипеда</del> bash-скрипта, чтобы дополнительно не нагружать систему и как визуализировали их с использованием нашего небольшого веб-сервиса.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="необходимые-инструменты">Необходимые инструменты<a href="#необходимые-инструменты" class="hash-link" aria-label="Direct link to Необходимые инструменты" title="Direct link to Необходимые инструменты">​</a></h2><ul><li>Устройство с процессором NXP LS1046a</li><li>Yocto на целевом устройстве или любой другой Linux дистрибутив</li><li>Доступ к терминалу на устройстве.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="решение-задачи">Решение задачи<a href="#решение-задачи" class="hash-link" aria-label="Direct link to Решение задачи" title="Direct link to Решение задачи">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="описание-скрипта-сбора-данных">Описание скрипта сбора данных<a href="#описание-скрипта-сбора-данных" class="hash-link" aria-label="Direct link to Описание скрипта сбора данных" title="Direct link to Описание скрипта сбора данных">​</a></h3><p>Для сбора данных о частоте и температуре процессора мы используем bash-скрипт. Этот скрипт собирает данные, записывает их в формат JSON и сохраняет в файл <code>cpu_data.json</code>. Давайте рассмотрим ключевые моменты скрипта:</p><ul><li><p>Мы передаем скрипту серийный номер/имя тестируемого устройства, длительность сбора данных и (опционально) примечание.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./cpu.sh SN001 </span><span class="token number" style="color:#36acaa">120</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Дополнительная заметка"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Скрипт определяет функции для получения текущего времени, метки времени, частоты процессора и температуры.</p><ul><li>Для LS1046a данные о частоте мы получаем из <code>/sys/devices/system/cpu/cpufreq/policy0/cpuinfo_cur_freq</code></li><li>Данны о температуре мы берем из <code>/sys/class/hwmon/hwmon3/temp1_input</code></li></ul></li><li><p>Данные собираются в цикле, каждую секунду, и записываются в формате JSON.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="разбор-скрипта-и-его-функций">Разбор скрипта и его функций<a href="#разбор-скрипта-и-его-функций" class="hash-link" aria-label="Direct link to Разбор скрипта и его функций" title="Direct link to Разбор скрипта и его функций">​</a></h3><ul><li>Проверка аргументов командной строки.</li><li>Определение функций для получения времени, метки времени, частоты и температуры.</li><li>Создание и форматирование JSON-файла.</li><li>Основной цикл сбора данных и записи их в JSON.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="готовый-скрипт">Готовый скрипт<a href="#готовый-скрипт" class="hash-link" aria-label="Direct link to Готовый скрипт" title="Direct link to Готовый скрипт">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Bash-script для ls1046a</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$#</span><span class="token plain"> -lt </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Usage: </span><span class="token string variable" style="color:#36acaa">$0</span><span class="token string" style="color:#e3116c"> &lt;serial_number&gt; &lt;duration_in_seconds&gt; &lt;note&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"note: optional parameter"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Example: </span><span class="token string variable" style="color:#36acaa">$0</span><span class="token string" style="color:#e3116c"> SN0001 10 </span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">Test 1</span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">serialnumber</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">duration</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">note</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$3</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">get_current_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">current_time</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> +</span><span class="token variable string" style="color:#e3116c">"%D %H:%M:%S"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$current_time</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">get_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">date</span><span class="token plain"> +%s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">get_cpu_frequency</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /sys/devices/system/cpu/cpufreq/policy0/cpuinfo_cur_freq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">get_cpu_temperature</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">val</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">cat</span><span class="token variable" style="color:#36acaa"> /sys/class/hwmon/hwmon3/temp1_input</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">result</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"scale=2; </span><span class="token variable string variable" style="color:#36acaa">$val</span><span class="token variable string" style="color:#e3116c"> / 1000.0"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">bc</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">printf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%.2f</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$result</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Collecting data for </span><span class="token string variable" style="color:#36acaa">$duration</span><span class="token string" style="color:#e3116c"> seconds..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">json_file</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"cpu_data.json"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'{"SN": "'</span><span class="token plain">"</span><span class="token variable" style="color:#36acaa">$serialnumber</span><span class="token string" style="color:#e3116c">"'"</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">' &gt; "$json_file"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">if [ -n "$note" ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  echo '</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"note"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"'"</span><span class="token variable" style="color:#36acaa">$note</span><span class="token string" style="color:#e3116c">"'"</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">' &gt;&gt; "$json_file"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">echo '</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"cpu"</span><span class="token plain">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">' &gt;&gt; "$json_file"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">end_time=$((SECONDS + duration))</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">while [ $SECONDS -lt $end_time ]; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  timestamp=$(get_timestamp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  frequency=$(get_cpu_frequency)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  temperature=$(get_cpu_temperature)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  get_current_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  echo "CPU Frequency: ${frequency} Hz"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  echo "Core Temperature: ${temperature}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  echo "  {\"timestamp\":$timestamp, \"frequency\":$frequency, \"temperature\":$temperature}," &gt;&gt; "$json_file"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  sleep 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">sed -i '</span><span class="token plain">$ s/,$//</span><span class="token string" style="color:#e3116c">' "$json_file"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">echo '</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token string" style="color:#e3116c">' &gt;&gt; "$json_file"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">echo '</span><span class="token plain">'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Done! Data written to </span><span class="token string variable" style="color:#36acaa">$json_file</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Пример формируемого json файла нашим скриптом:</strong></p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">cpu_data.json</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"SN"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"SN0001"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"note"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"This is a note"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"cpu"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713925</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3219.181</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">61.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713926</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2740.720</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">59.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713927</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1705.188</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">61.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713928</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3010.267</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">68.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713929</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1500.000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">59.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713930</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1500.000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">58.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713931</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3860.388</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">58.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713932</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">457.516</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">59.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713933</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1500.000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">59.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1692713934</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"frequency"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1500.000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"temperature"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">57.0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="визуализация-данных">Визуализация данных<a href="#визуализация-данных" class="hash-link" aria-label="Direct link to Визуализация данных" title="Direct link to Визуализация данных">​</a></h2><p>Для визуализации данных мы используем веб-компонент на React, который можно найти по ссылке <a href="/en/cpuChart">cpuChart</a>. Этот сервис позволяет загружать и визуализировать данные из JSON-файла.</p><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAFAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAII/8QAHBAAAgICAwAAAAAAAAAAAAAAAAECEQMhIkGR/8QAFAEBAAAAAAAAAAAAAAAAAAAAAv/EABURAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIRAxEAPwDUEmlFTrku7JWadLa8AERW/9k=&quot;)"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="480" height="240"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/en/assets/ideal-img/chart.21b7a9b.480.jpg" srcset="/en/assets/ideal-img/chart.21b7a9b.480.jpg 480w,/en/assets/ideal-img/chart.3085d79.664.jpg 664w,/en/assets/ideal-img/chart.9ea7483.847.jpg 847w,/en/assets/ideal-img/chart.3b03ac4.1030.jpg 1030w" width="480" height="240"></noscript></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="заключение">Заключение<a href="#заключение" class="hash-link" aria-label="Direct link to Заключение" title="Direct link to Заключение">​</a></h2><p>В данной статье мы рассмотрели, как решить задачу сбора данных о частоте и температуре процессора без установки дополнительного программного обеспечения. Мы использовали bash-скрипт для сбора данных и веб-сервис для их визуализации, который к слову, тоже написан нами. Этот подход позволил нам решить нашу задачу по анализу и мониторингу процессора LS1046a во время проводимых нагрузочных тестирований. Надеюсь эта информация будет кому-то полезна.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="полезные-ссылки">Полезные ссылки<a href="#полезные-ссылки" class="hash-link" aria-label="Direct link to Полезные ссылки" title="Direct link to Полезные ссылки">​</a></h2><ul><li><a href="https://gist.github.com/IgorKha/4120abd76796217ad5836b1dc1517aa9" target="_blank" rel="noopener noreferrer">Скачать</a> данный скрип актуальной версии можно всегда на <strong>Github Gist</strong></li><li><a href="/en/cpuChart">cpuChart</a> для отображения данных из json файла <code>cpu_data.json</code></li></ul>]]></content:encoded>
            <category>1046</category>
            <category>NXP</category>
            <category>CPU</category>
            <category>chart</category>
            <category>bash</category>
            <category>monitoring</category>
        </item>
        <item>
            <title><![CDATA[Летопись платы nxp ls1046 (от мертвого к живому)]]></title>
            <link>https://lab240.github.io/en/blog/hard-1046-log-blog</link>
            <guid>https://lab240.github.io/en/blog/hard-1046-log-blog</guid>
            <pubDate>Sat, 26 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Мы вышли на финишную прямую в подъеме платы на nxp ls1046 и как руководитель группы разработки, как говорится, имею что сказать. Это будет не по технике (отчасти), а о процессе и жизни разработчика. Вся эта история заняла 3 недели у команды из 5 человек  это был очень непростой интенсивный процесс. Важно его описать и сделать выводы, что я и делаю.]]></description>
            <content:encoded><![CDATA[<p>Мы вышли на финишную прямую в подъеме платы на nxp ls1046 и как руководитель группы разработки, как говорится, имею что сказать. Это будет не по технике (отчасти), а о процессе и жизни разработчика. Вся эта история заняла 3 недели у команды из 5 человек  это был очень непростой интенсивный процесс. Важно его описать и сделать выводы, что я и делаю.</p><p>!<img loading="lazy" alt="Alt text" src="/en/assets/images/plate-with-monitor-49bef1526609f5b8cadb75e182e52cb6.jpg" width="1280" height="720" class="img_ev3q"></p><p>Мы делаем проект, в котором схемотехники делают плату на ls1046 с двумя модемами на 60ГГц (802.11ad) и первоначально я видел задачу нашей группы как чисто программную - выстроить устройства на этих платах в MESH-сеть, запустить процессы раздачи авторизаций, балансировку трафика, раздачи сервисов и прочие высокоуровневые плюшки SDN-а... как же далек от реальности я был...</p><p>Началось все с того, что принося сырую плату, нас сразу же включили в работу, так как по мнению схемотехников если побежали циферки в консоли, то дальше программисты должны настроить и залить софт и все будет отлично. Программисты же, наоборот, резонно считают, что если есть прошивка, которая работала на плате разработчика, то эта прошивка обязана работать и на плате, которую сделали схемотехники и нечего приносить иное. И посреди этих двух полярных мнений оказались мы.</p><p>В качестве отступления, могу сказать, что наша группа и сама делает платы и занимается трассировкой и мы точно знаем что на первых выпусках любых плат есть ошибки. Притом, они могут быть по схемотехнике (не додумали), по реализации (подумали так, а оно на оно на самом деле совсем не так) и просто ошибки сборки платы (есть еще вероятность некачественных компонент, но такого я не встречал пока).  Хорошая плата, если она делается с нуля в лучшем случае получается с третьего захода, но иногда ошибки таковы что плата идет в помойку, а иногда можно найти косячки, "допилить" и плата становится функциональной или "частично функциональной" и понятно как делать следующий заказ.
<strong>Главное при таком заказе не придумать и не внести новую функциональность</strong></p><p>Итак "больной" поступил с зависанием на стадии BL1 и без возможности зацепиться JTAG-ом. Фирменный софт CodeWarrior просто не видел платы. Так как это уже вторая итерация платы (у первой была неправильно разведена память), то мы не могли так ошибиться по памяти, нужно было искать и запускать. Иногда, это напоминало сериал "Доктор Хаус", иногда хотелось просто отправить плату в утиль, но мы добились стабильной работы и точно знаем что следующий выпуск будет стабильным (при исполнении протокола изменений).</p><p>Что делалось и что было сделано.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="шаг1-процедура-запуска-процессора">ШАГ1. Процедура запуска процессора.<a href="#шаг1-процедура-запуска-процессора" class="hash-link" aria-label="Direct link to ШАГ1. Процедура запуска процессора." title="Direct link to ШАГ1. Процедура запуска процессора.">​</a></h3><p>Первое с чего начинается запуск любой платы это старт процессора. Раз он не получает JTAG, значит процедура не соблюдена. Да, у процессора своя процедура запуска с строгой подачей питания и сигналов RESET на нужные пины с нужной задержкой. Запуском  и сбросом платы коллеги поставили управлять отдельный микроконтроллер, который явно работал неправильно. Для справки, в "дев борде" для этого стоит ПЛИС тоже без особенной документации, но сама процедура старта описана в документации полно.</p><p>Чтобы не сражаться с схемотехниками их МК был отпаян и припаян наш STM32, для  которого мы залили прошивку , реализующую процедуру старта.</p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/photo_2023-08-09_22-56-01-3d08fe43c198424f1df1c3ccd92218d6.jpg" width="790" height="461" class="img_ev3q"></p><p>Также были обнаружены недостающие детальки</p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/absetn-2-bd67583fdfdc8cf0ee0d8ff48e9d7bc2.jpg" width="1000" height="749" class="img_ev3q"></p><p>Итак, через какое-то время мы попали в CW (CodeWarrior), и смогли настроить RCW для памяти, а еще через какое-то время туже процедуру написали для оригинального МK.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="шаг2-питание-питание-и-еще-раз-питание">ШАГ2. Питание питание и еще раз питание<a href="#шаг2-питание-питание-и-еще-раз-питание" class="hash-link" aria-label="Direct link to ШАГ2. Питание питание и еще раз питание" title="Direct link to ШАГ2. Питание питание и еще раз питание">​</a></h3><p>Следующая беда которая была с уже загружающейся платой - это нестабильность работы. В прошлый раз это были ошибки в импедансах (задержках) в дорожках, но в этот раз предварительно все было трассировано в xSignals и поэтому копать пришлось в сторону правильного питания. Вообще, питание и обратная связь по питанию, это то, на что легко забить и с чем потом можно бесконечно долго мучиться. Итак, проверка питания и проверка обратно связи по питанию привела к замене пачки резисторов, установке керамических конденсаторов и добавлением везде, где можно обратной связи по питанию. </p><p>Но в результате, если плата сильно не стабильна надо было найти было что-то довольно грубое и оно было найдено, там где надо было подать 0.6В, было подано 1,2B. В результате память "ожила" а после подстройки RCW стала стабильной по memtest-у.</p><p>Надо сказать, что любой схемотехник автор платы вовсе не счастлив признавать свои ошибки и склонен и у него как правило два мнения "ваши предложения ни на что не влияют" и "у меня &lt;где-то&gt; и тк работает. Поэтому буквально сначала приходилось перепаиваться на своем экземпляре "чтоб воду не толочь" и после этого уже отдавать протокол изменений авторам платы.</p><p><em>Отметим, чтобы не забыть - разбираться в чужой плате, даже при наличии всех схем и проекта на порядок тяжелее, чем в "своей".</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="шаг3-несущие-частоты-тяжелый-случай">ШАГ3. Несущие частоты. Тяжелый случай.<a href="#шаг3-несущие-частоты-тяжелый-случай" class="hash-link" aria-label="Direct link to ШАГ3. Несущие частоты. Тяжелый случай." title="Direct link to ШАГ3. Несущие частоты. Тяжелый случай.">​</a></h3><p>После стабилизации питания, стабилизации процедуры запуска, стабилизации reset-ов процессора мы получили "почти рабочую" плату. А именно плату с 1хGB и 2xPCI (где у нас находятся модемы), но без 10Гбит. </p><p>В 1046-м два 10Гбит интерфейса, за которые изначально было страшновато по нескольким причинам:</p><ol><li>Это высокоскоростные интерфейсы под SFP+ пальцы</li><li>Интерфейсы работают в одной из плат через ретаймеры, в другой напрямую из процессора.</li><li>Интерфейсы работают через SerDes.</li><li>Такие интерфейсы используются редко, и спросить по большому счету не у кого.</li></ol><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Справка от ChatGPT</div><div class="admonitionContent_S0QG"><p>SerDes - это сокращение от "Serializer/Deserializer" (сериализатор/десериализатор). Это технология, которая используется для преобразования данных между параллельным и последовательным форматами. В основном, SerDes преобразует данные из формата, который может передаваться одновременно по нескольким проводникам (параллельный), в формат, который передается последовательно по одному проводнику (серийный), и наоборот.</p><p>Примеры использования SerDes включают в себя передачу данных между компонентами компьютера, такими как микропроцессоры и память, а также в средствах связи, например, для преобразования данных между оптическими и электрическими сигналами в сетях передачи данных.</p><p>В общем, SerDes помогает эффективно и надежно передавать данные между устройствами и компонентами, используя разные методы кодирования и модуляции для оптимизации скорости и качества передачи данных.</p></div></div><p>При диагностике мы установили, что SerDes1 в режиме XFI не видит опорную частоту и не может, соответственно, запустить ни одно устройство через себя. В результате выяснили, что нужные "ножки" процессора вообще не задействованы и частоты там быть и не может.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Из карты "больного"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Исходя из ДШ на чип</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Serdes 1 в режиме XFI должен брать источником PLL2 замуксованный через rcw на RefCLK2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">refclk2 не подключен</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Alt text" src="/en/assets/images/pins-1-c8a554d846a2f661252b889a24d8f2ef.jpg" width="1177" height="464" class="img_ev3q"></p><p>Заказчик, надо отдать ему должное, был готов этот этап принять с 1Гбит сетью, но нам как то было "западло" такое сдавать и мы продолжили мучиться.</p><p>В целом поступило смелое предложение сверлить текстолит и "пробиваться" к шарику процессора, чтобы подцепить волосок в нужную площадку. Эта процедура хирургическая, но возможная. </p><p>Однако мы стали думать, где уже есть частота. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Из выписки "больного"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PLL2 согласно DS может брать колок от первого или второго входа SD1_REF_CLK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Надо было грубо править RCW</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Справка от ChatGPT</div><div class="admonitionContent_S0QG"><p>RCW - это сокращение от "Reset Configuration Word" или "Слово Конфигурации Сброса". В контексте запуска микропроцессоров и систем на базе процессоров от NXP Semiconductors (ранее Freescale Semiconductor), RCW представляет собой специальный блок данных или параметров, который используется для настройки поведения процессора и системы при запуске или после сброса.</p><p>Когда микропроцессор начинает работу или перезагружается, он считывает RCW, который хранится в некоторой перманентной памяти, и использует эту информацию для настройки различных аспектов своей работы. Например, RCW может содержать информацию о том, какие интерфейсы и устройства должны быть активированы, какие параметры тактовой частоты следует установить, и другие конфигурационные данные.</p><p>RCW обычно настраивается в процессе проектирования и настройки системы, и он может быть уникален для каждой конкретной системы на базе микропроцессора от NXP. Это позволяет разработчикам настраивать параметры системы под свои нужды, оптимизируя ее работу для конкретных приложений.</p><p>Важно правильно настроить RCW, так как это влияет на инициализацию и работу микропроцессора и системы в целом. Обычно, в документации к конкретному микропроцессору или системной плате от NXP, вы найдете подробные инструкции по настройке RCW для вашей системы.</p></div></div><p>Для того, чтобы "хакнуть" даташит пришлось написать небольшой <a href="/en/1046hextobin">дешифратор RCW</a>, чтобы из лога загрузки считывать какие значения принимают параметры.</p><p>Понятно, что "через костыль" но 10Гбит увиделись и заработали с поправленным RCW.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="шаг4-температура">ШАГ4. Температура<a href="#шаг4-температура" class="hash-link" aria-label="Direct link to ШАГ4. Температура" title="Direct link to ШАГ4. Температура">​</a></h3><p>После этого осталась не сильно зависящая от нас часть - это провести стресс тесты и замерить температуры в пассивном корпусе. </p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/with-case-1-f054c86f28b92e762dd142785d3eb65e.jpg" width="468" height="508" class="img_ev3q"></p><p>Для процессора опять же был написан <a href="/en/cpuChart">скрипт</a> и сервис, строящий графики на основе получаемого json-a.</p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/chart1-65d51aad294e83cc513f52751573f052.png" width="793" height="572" class="img_ev3q"></p><p>Интересно, что греется не столько процессор (он умеет снижать частоту при высокой температуре), сколько активные антенны 60Ггц, но хороший радиатор позволяет и их "держать" в диапазоне до 60 градусов.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="выводы-вместо-постскриптума">Выводы (вместо постскриптума)<a href="#выводы-вместо-постскриптума" class="hash-link" aria-label="Direct link to Выводы (вместо постскриптума)" title="Direct link to Выводы (вместо постскриптума)">​</a></h3><p>Из любого "подвига" нужно делать выводы, чтобы его не повторять. </p><p>При проектировании сложных плат нужно придерживаться следующих принципов</p><ol><li><strong>Делать дизайн как можно ближе к работающей "девборде".</strong> Чем ближе ваш девайс к девборде, тем меньше изменений в софте. Да, как показала практика, можно делать "лютый" кастом, но время и риски возрастают. Разработчики процессоров и обвязки имеют все-равно больше опыта, а документация всегда не бесспорна. Погружаться в страшную документацию на тысячи страниц долго, тяжело и рискованно.</li><li><strong>Не смотря на предыдущий опыт, при дизайне платы максимально уделить времени импедансам, переходам, углам, длинам линий.</strong> Это банально, но надо трассировать и проверять всеми существующими  инструментами. Нельзя оставлять выбивающиеся "желтые" или "красные" места, потому что до этого так где-то работало или потому что и так должно работать. В этом слоеном пироге и так все будет глючить, не надо добавлять сомнительных сущностей.</li><li><strong>*Если на девборде есть "странные" или "ненужные" части (фильтры, подтяжки, делители, ретаймеры) - не игнорировать их.</strong> Разбираться зачем они и если непонятно, все-равно ставить. </li><li><strong>Выводить на плату площадки для измерений и "подпайки".</strong> Надо думать о том, где вы сможете промерить опорные напряжения и частоты, куда подпаяться при необходимости контрольный разъем.</li><li><strong>У процессоров своя сложная система старта, необходимо уделить этому внимание.</strong> Как показал наш пример, старт процессора - отдельная программа на MCU, ошибки в которой вообще не позволяют старт системы.</li><li><strong>Уделяйте особое внимание питанию и обратной связи по питанию.</strong> Ошибки по питанию ведут к плавающим непредсказуемым глюкам при нагрузках, которые тяжело поймать и объяснить.</li><li><strong>Всегда при менеджменте проекта предполагать, что в плате могут быть такие ошибки, что понадобиться ее перезаказывать с исправлениями. Не все можно сделать на лету.</strong>. Цикл заказа с исправлениями - 2 месяца, это надо заложить в контракт. </li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="спасибо-котам-покровителям">Спасибо котам-покровителям<a href="#спасибо-котам-покровителям" class="hash-link" aria-label="Direct link to Спасибо котам-покровителям" title="Direct link to Спасибо котам-покровителям">​</a></h3><p>Наши коты-покровители, к которым мы виртуально прикладываем платы, в моменты отчаяния и нервного напряжения (а они были).</p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/cats-6e5d3d1aa39974b580a33c123ca1cbcc.png" width="697" height="256" class="img_ev3q"></p>]]></content:encoded>
            <category>team</category>
            <category>lab240</category>
        </item>
        <item>
            <title><![CDATA[Работа с данными в Telegraf]]></title>
            <link>https://lab240.github.io/en/blog/telegraf-starlark</link>
            <guid>https://lab240.github.io/en/blog/telegraf-starlark</guid>
            <pubDate>Mon, 21 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Предисловие. О Telegraf]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="предисловие-о-telegraf">Предисловие. О Telegraf<a href="#предисловие-о-telegraf" class="hash-link" aria-label="Direct link to Предисловие. О Telegraf" title="Direct link to Предисловие. О Telegraf">​</a></h2><p>Telegraf универсальный инструмент перекладывания данных от источников данных к приемникам данных. Классическим источником данных являются протоколы опроса датчиков, такие как modbus\mqtt, а классическим приемником данных являются базы данных (influxdb, mysql). Наличие сотен плагинов для Telegraf освобождает нас от написания микросервисов по перекладыванию данных, а применять один инструмент.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><ul><li>Ссылка на Telegraf: <a href="https://www.influxdata.com/time-series-platform/telegraf/" target="_blank" rel="noopener noreferrer">https://www.influxdata.com/time-series-platform/telegraf/</a></li><li>Ссылка на плагины Telegraf: <a href="https://docs.influxdata.com/telegraf/v1.26/plugins/" target="_blank" rel="noopener noreferrer">https://docs.influxdata.com/telegraf/v1.26/plugins/</a></li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="применение-telegraf">Применение Telegraf<a href="#применение-telegraf" class="hash-link" aria-label="Direct link to Применение Telegraf" title="Direct link to Применение Telegraf">​</a></h2><p>Мы используем "комбайн" Telegraf в наших решениях по сбору данных и любим его за универсальность.</p><p>Пример конфиг для сбора данных по modbus выглядит так</p><p>Modbus TCP</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[[inputs.modbus]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = "Device"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slave_id = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout = "3s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  controller = "tcp://127.0.0.1:502" </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  holding_registers = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "elemy_binary1", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [0]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "elemy_binary2", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [1]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Modbus rtu (на примере датчика окружающей среды IPCDAS FS-C1)</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## FrontSensor C1 Шаблон для встроенного датчика тока</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[inputs.modbus]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = "FS-C1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slave_id = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout = "10s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # busy_retries = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # busy_retries_wait = "100ms"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  controller = "file:///dev/ttyS1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  baud_rate = 9600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data_bits = 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  parity = "N"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stop_bits = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  transmission_mode = "RTU"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  holding_registers = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Volt_a",   byte_order = "AB",   data_type = "UINT16",   scale=0.01,     address = [72]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Amp_a",    byte_order = "AB",   data_type = "UINT16",   scale=1.0,      address = [73]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "W_a",      byte_order = "AB",   data_type = "UINT16",   scale=1.0,      address = [74]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "PF_a",     byte_order = "AB",   data_type = "UINT16",   scale=1.0,      address = [77]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Freq_a",   byte_order = "AB",   data_type = "UINT16",   scale=0.01,     address = [81]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>MQTT Config (на примере платформы donoff)</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[inputs.mqtt_consumer]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  servers = ["tcp://SERVER:1883"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  topics = ["/donoff/+/out/sensors/+"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username = "MQTT_USER"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password = "MQTT_PASS"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data_format = "value"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data_type = "string"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[inputs.mqtt_consumer.topic_parsing]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    topic = "/donoff/+/out/sensors/+"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags = "/prj/dev/_/_/_"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fields = "/_/_/_/_/sensor_name"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="преобразование-данных">Преобразование данных<a href="#преобразование-данных" class="hash-link" aria-label="Direct link to Преобразование данных" title="Direct link to Преобразование данных">​</a></h2><p>Прежде чем данные пойдут в приемник, они могут быть обработаны, так называемыми процессорами. Не всегда получаемые готовы в прямом виде поступить в туже базу данных. Надо отфильтровать ненужные (лишние), преобразовать типы, и даже получить новые данные на основе исходных.</p><p>Пример простого процессора для MQTT</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[[processors.pivot]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tag_key = "sensor_name"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value_key = "value"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Однако, существует гораздо более мощный инструмент для преобразования данных - полноценный язык Starlark, синтаксис которого очень близок к Python.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>Описание языка Starlark: <a href="https://github.com/bazelbuild/starlark/blob/master/spec.md" target="_blank" rel="noopener noreferrer">https://github.com/bazelbuild/starlark/blob/master/spec.md</a></p></div></div><p>Пример раззбора топиков и значений из MQTT</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[[processors.starlark]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # Reads the Starlark script embedded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = '''</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def apply(metric):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #Разбор поля с названием сенсора </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sm=str(metric.fields['sensor_name'])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #Можно "пропустить" данные которые не нужны</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if sm == 'pzem004':</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return metric</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #Преобразование типа данных</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sv=float(metric.fields['value'])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #Преобразуем вместо value=значение к имя_сенсора=значение</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields[metric.fields['sensor_name']]=sv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #Добавляем новое поле type (тип датчика) на основе имени дачтика и делаем undef если не удалось распознать.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if 'temp' in sm:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields['type']='temp'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elif ('curr' in sm) or ('sct' in sm) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields['type']='current'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elif ('sec' in sm):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields['type']='seconds'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elif ('power' in sm):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields['type']='power'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elif ('energy' in sm):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields['type']='energy'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elif ('energy' in sm):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields['type']='volt'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric.fields['type']='undef'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #Убираем лишние метрики    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields.pop('value')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.tags.pop('topic')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields.pop('sensor_name')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return metric</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'''</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Еще один пример применения starlark - разбор приходящих данных из modbus источника на биты (вот так придумал производитель)</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[inputs.modbus]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = "Device"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slave_id = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout = "3s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  controller = "tcp://127.0.0.1:502"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  holding_registers = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "elemy_binary1", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [0]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[processors.starlark]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # Reads the Starlark script embedded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = '''</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def apply(metric):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ei=metric.fields['elemy_binary1']</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Готовим массив из 16 значений</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bit_array=[None]*16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Берем входящее значение и раскладываем каждый бит в элементы массива</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for i in range(0,16):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   bit_array[i]=(ei&gt;&gt;i) &amp; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Формируем метрики на основе битов (некоторые метрики multi_bit) согласно документации на устройство</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['priority']=bit_array[1]+2*bit_array[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['switch_mode']=bit_array[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['is_input1_norm_state']=bit_array[8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['is_input2_norm_state']=bit_array[9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['is_input1_active']=bit_array[10]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['is_input2_active']=bit_array[11]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['load_state']=bit_array[13]+2*bit_array[12]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['is_out_voltage1']=bit_array[14]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metric.fields['is_out_voltage2']=bit_array[15]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return metric</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'''</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Надеемся из этих примеров становится понятно, насколько гибок и универсален инструмент Starlark.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Фантастические возможности, учитывая что данные в Telegraf могут быть взяты из многих и разных по природе источников. А далее с помощью простых программ на Starlark - обработаны, подчищены, добавлены и выданы в приемник.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="приемник-данных">Приемник данных<a href="#приемник-данных" class="hash-link" aria-label="Direct link to Приемник данных" title="Direct link to Приемник данных">​</a></h2><p>В качестве примера приведем вывод данных в базу данных influx_v2. Как видно, конфиг абсолютно "тупой", потому что все данные мы уже подготовили !</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[outputs.influxdb_v2]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## The URLs of the InfluxDB cluster nodes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Multiple URLs can be specified for a single cluster, only ONE of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## urls will be written to each interval.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ##   ex: urls = ["https://us-west-2-1.aws.cloud2.influxdata.com"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  urls = ["http://mon_influxdb2:8086"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Token for authentication.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token = "TOKEN"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Organization is the name of the organization you wish to write to.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  organization = "nnzipc"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Destination bucket to write into.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bucket = "bucket1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## The value of this tag will be used to determine the bucket.  If this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## tag is not set the 'bucket' option is used as the default.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # bucket_tag = ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## If true, the bucket tag will not be added to the metric.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # exclude_bucket_tag = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Timeout for HTTP messages.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # timeout = "5s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Additional HTTP headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # http_headers = {"X-Special-Header" = "Special-Value"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## HTTP Proxy override, if unset values the standard proxy environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## variables are consulted to determine which proxy, if any, should be used.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # http_proxy = "http://corporate.proxy:3128"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## HTTP User-Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_agent = "telegraf"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Content-Encoding for write request body, can be set to "gzip" to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## compress body or "identity" to apply no encoding.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # content_encoding = "gzip"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Enable or disable uint support for writing uints influxdb 2.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # influx_uint_support = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Optional TLS Config for use on HTTP connections.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # tls_ca = "/etc/telegraf/ca.pem"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # tls_cert = "/etc/telegraf/cert.pem"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # tls_key = "/etc/telegraf/key.pem"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Use TLS but skip chain &amp; host verification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # insecure_skip_verify = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>💥 Удачи Вам (и нам) в передаче и преобразовании данных</p>]]></content:encoded>
            <category>team</category>
            <category>lab240</category>
        </item>
        <item>
            <title><![CDATA[Собираем аналитику с ПДУ *)]]></title>
            <link>https://lab240.github.io/en/blog/dmn-prj-na-1</link>
            <guid>https://lab240.github.io/en/blog/dmn-prj-na-1</guid>
            <pubDate>Fri, 18 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[*) Статья не совсем готова, ссылки могут и скорее всего не]]></description>
            <content:encoded><![CDATA[<div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>*) Статья не совсем готова, ссылки могут и скорее всего не
работают. Как все будет готово, снимем эту плашку.</p></div></div><p>Про то, как мы быстро сделали систему визуализации работы ПДУ</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="предистория">Предистория<a href="#предистория" class="hash-link" aria-label="Direct link to Предистория" title="Direct link to Предистория">​</a></h2><p>Есть такой известный бренд в мире управления питанием для стоек в дата центрах - Raritan. Маститый вендор, предоставляющий софт с кучей аналитики по работе оборудования. А есть молодой производитель Elemy, у которого есть веб-интерфейс для просмотра текущих параметров, но нет аналитики. Для начала мы взяли устройство <a href="https://www.elemy.ru/products/ats-1204" target="_blank" rel="noopener noreferrer">"АВТОМАТИЧЕСКИЙ СТОЕЧНЫЙ ПЕРЕКЛЮЧАТЕЛЬ
ATS-1204"</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="аналитика-за-полчаса-">Аналитика за полчаса ?<a href="#аналитика-за-полчаса-" class="hash-link" aria-label="Direct link to Аналитика за полчаса ?" title="Direct link to Аналитика за полчаса ?">​</a></h2><p>Хороший факт -  Elemy "отдает" состояние линий и все электрические параметры по modbbus. Это значит, что собрать и показать аналитику нет особенной сложности. Тем более, что у нас есть практически готовый докер для связки mqtt-telegraf-influx-grafana. В данном случае нам mqtt не нужна, мы можем отключить ее, а вот остальное весьма понадобиться.</p><p>Итак, нам дали Windows сервер (да, ужас), но слава Богу и там есть докер.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="разворачиваем-докер-на-win-сервере">Разворачиваем докер на Win сервере<a href="#разворачиваем-докер-на-win-сервере" class="hash-link" aria-label="Direct link to Разворачиваем докер на Win сервере" title="Direct link to Разворачиваем докер на Win сервере">​</a></h2><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>Докер для Win: <a href="https://www.docker.com/products/docker-desktop/" target="_blank" rel="noopener noreferrer">https://www.docker.com/products/docker-desktop/</a></p></div></div><p>Наш готовый докер с инструкцией по разворачиванию  <a href="https://gitlab.nnz-ipc.net/iot/grafana-influx" target="_blank" rel="noopener noreferrer">https://gitlab.nnz-ipc.net/iot/grafana-influx</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="конфиг-telegraf">Конфиг telegraf<a href="#конфиг-telegraf" class="hash-link" aria-label="Direct link to Конфиг telegraf" title="Direct link to Конфиг telegraf">​</a></h2><p>Telegraf - мощнейшее средство перекладывания данных из источника к премнику. В нашем случа источник modbus rtu, а приемник база influxdb. Мы должны забрать регистры Elemy ATS-1204 (полная карта регистров есть на сайте производителя).</p><p>Вот так выглядит конфиг telegraf для Elemy ATS-1204 "на вход"</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[inputs.modbus]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = "Device"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slave_id = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout = "10s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  controller = "tcp://192.168.0.36:502"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  configuration_type = "register"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  holding_registers = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Volt_output", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [2]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Volt_input1", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [5]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Volt_input2", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [6]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Freq_input1", byte_order = "AB",   data_type = "UINT16", scale=0.01,  address = [7]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Freq_input2", byte_order = "AB",   data_type = "UINT16", scale=0.01,  address = [8]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Amp_output", byte_order = "AB",   data_type = "UINT16", scale=0.01,  address = [9]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Volt-ampere", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [10]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Watt", byte_order = "AB",   data_type = "INT16", scale=1.0,  address = [11]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Volt-ampere-reactive", byte_order = "AB",   data_type = "UINT16", scale=1.0,  address = [12]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { name = "Cos-ph", byte_order = "AB",   data_type = "INT16", scale=1.0,  address = [13]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>В приемнике (на выход) - никаких изменений (приемник - база influxv2)</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[outputs.influxdb_v2]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  urls = ["http://mon_influxdb2:8086"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token = "INFLUXDB TOKEN"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bucket = "bucket1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## HTTP User-Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_agent = "telegraf"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="дашбоард-для-grafana">Дашбоард для grafana<a href="#дашбоард-для-grafana" class="hash-link" aria-label="Direct link to Дашбоард для grafana" title="Direct link to Дашбоард для grafana">​</a></h2><blockquote><p><a target="_blank" href="/en/assets/files/ATS-1204-1692355913043-21998d0622d7cf335a9e7e4a6597ee84.json">Cкачать json c дашбоард для  Elemy ATS-1204</a></p></blockquote><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>В графане его надо импортировать через интерфейс управления.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="результат">Результат<a href="#результат" class="hash-link" aria-label="Direct link to Результат" title="Direct link to Результат">​</a></h2><p>После выполнения несложных манипуляций мы получили вот такую дашборду в графане. Теперь наши партнеры имеют возможность получить аналитику по работе устройства в лбом разрезе и времени. Мало того, они могут самостоятельно доработать дашборду в графане на свой вкус и цвет.</p><p><img loading="lazy" alt="Grafana dashboard" src="/en/assets/images/grf1-48045489d644d4978d729babc942191a.gif" width="1450" height="994" class="img_ev3q"></p>]]></content:encoded>
            <category>team</category>
            <category>lab240</category>
        </item>
        <item>
            <title><![CDATA[Поднимаем плату на nxp ls1046 (жизнь)]]></title>
            <link>https://lab240.github.io/en/blog/hard-1046-start</link>
            <guid>https://lab240.github.io/en/blog/hard-1046-start</guid>
            <pubDate>Thu, 10 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Тяжёлый запуск новой платы, сложный процессор и протоколы запуска. Но мы понемногу движемся к стабилизации процедуры старта и описанию периферии.]]></description>
            <content:encoded><![CDATA[<p>Тяжёлый запуск новой платы, сложный процессор и протоколы запуска. Но мы понемногу движемся к стабилизации процедуры старта и описанию периферии.</p><p><img loading="lazy" alt="dok-ls1046" src="/en/assets/images/dok-ls1046-d3013da9a46a9e9c88850d8d16b6e3ee.jpg" width="960" height="540" class="img_ev3q"></p><p>Процессор nxp ls1046, память ddr4, сеть 10gb, 3x pci-e. Плата будет базовым роутером для сетей 802.11ad в диапазоне 60ГГц.</p><p>К сожалению, плата  сильно отличается от nxp devboard ls1046-ardb, поэтому конфигурации и деревья устройств упали на нас. Там конечно свой космос на стыке железа и конфигурации загрузчиков, чтобы объяснить загрузчикам Линуксу что там вообще есть.</p><p>Для примера, прежде чем запустить загрузку Линукс есть 5 стадий загрузчика и uboot. Позже опубликуем некоторые аспекты загрузки этой платы (BL1...3, TF-A).</p><p>:wq</p>]]></content:encoded>
            <category>ls1046a</category>
            <category>NXP</category>
        </item>
        <item>
            <title><![CDATA[Передача данных "поезд-земля" (статья)]]></title>
            <link>https://lab240.github.io/en/blog/dmn-prj-elva1-1</link>
            <guid>https://lab240.github.io/en/blog/dmn-prj-elva1-1</guid>
            <pubDate>Mon, 24 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Вместо пролога]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="вместо-пролога">Вместо пролога<a href="#вместо-пролога" class="hash-link" aria-label="Direct link to Вместо пролога" title="Direct link to Вместо пролога">​</a></h2><p><em>Скорости растут, поезда несутся, а дремучий "французский" GSM (а он был таковым на этапе своего зарождения в начале 90-x)  вытеснил CDMA.</em></p><p><em>Теперь уже мало кто вспомнит, что впервые в России возможность мобильного интернета на скоростях мобильной станции до 200 км\ч была доступна только в сетях стандартов: CDMA-2000 AKA CDMA-450 AKA IMT-450i .</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="проект-поезд-земля-и-сложные-задачи-передачи-данных">Проект "поезд-земля" и сложные задачи передачи данных<a href="#проект-поезд-земля-и-сложные-задачи-передачи-данных" class="hash-link" aria-label="Direct link to Проект &quot;поезд-земля&quot; и сложные задачи передачи данных" title="Direct link to Проект &quot;поезд-земля&quot; и сложные задачи передачи данных">​</a></h2><p>В большом проекте по обеспечению надежной высокоскоростной (10Гбит\с) связью "поезд-земля", наша команда отвечает за разработку решения для высокоскоростной передачи данных со сверх быстрым переключением каналов (в сотовой связи аналогом является механизм переключения радиотракта между БС и МС, "перехват", он же - "handover").</p><p><img loading="lazy" alt="Train-Earth" src="/en/assets/images/train2-39ac0ebdf2299971cf2e62ab7c80c06c.png" width="718" height="210" class="img_ev3q"></p><p>Проект передачи данных вдоль линии ЖД характеризуется впечатляющими обывателя цифрами  - это сотни километров оптоволокна, тысячи РРС (Радио-релейных станций), служба мониторинга и управления OSS/BSS, десятки поездов и бригад обеспечения на дрезинах). И наша небольшая (в масштабах реализации первой в РФ Track Side Network), но сложная задача - <strong>сделать подвижный поезд и все что в нем находится надежным "стационарным" сетевым клиентом</strong>.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Пресса и материалы по теме</div><div class="admonitionContent_S0QG"><ul><li><a href="https://habr.com/ru/articles/739496/" target="_blank" rel="noopener noreferrer">Статья</a> на Хабре про технологию "поезд-земля" и сравнение ее с WiFi и LTE.</li><li><a href="https://www.youtube.com/watch?v=t48YXALtb-M" target="_blank" rel="noopener noreferrer">Ролик</a> на Youtube</li><li><a href="https://dokltd.ru/data/files/docs/dok-train-to-ground-ppc-10gbit.pdf" target="_blank" rel="noopener noreferrer">Описание Радио-мостов "поезд-земля (pdf)"</a> на сайте dokltd.ru</li></ul></div></div><p>В своих разработках мы подразумеваем современный поезд, который движется на высоких скоростях (до 300км\ч).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="передача-данных-земля-поезд">Передача данных "земля-поезд"<a href="#передача-данных-земля-поезд" class="hash-link" aria-label="Direct link to Передача данных &quot;земля-поезд&quot;" title="Direct link to Передача данных &quot;земля-поезд&quot;">​</a></h2><p>💥 Термин РРС расшифровывается как <strong>Радио-Релейная Станция</strong>.</p><p>Суть технологии передачи данных "земля-поезд" в том, что на поезде стоит радио-релейное оборудование (РРС), которое "смотрит" вперед и назад. В каждый момент
времени мы "видим" и "теряем" базовые станции впереди поезда и сзади поезда и необходимо переключать путь прохождения трафика между парами РРС. Путь прохождения трафика (здесь и далее <strong>ППТра</strong>) - путь, образованный парой РРС на базе (столбе) и на поезде (на носу или кормовой части).</p><p>В решении используются две основных функциональных компоненты:</p><ul><li><p><strong>CGW (Central GateWay)</strong> - маршрутизатор, устанавливаемый на "земле" (в диспетчерской или в дата-центре)</p></li><li><p><strong>TTR (Train Track Router)</strong>  - маршрутизатор, устанавливаемый на подвижном объекте (в нашем случае это первый и последний вагоны поезда)</p></li></ul><p>💥 Далее довольно часто мы будем использовать термин  ППТра - расшифровывается <strong>как П<!-- -->[уть]<!-- --> П<!-- -->[рохождения]<!-- --> Тра<!-- -->[фика]</strong>.</p><p>Упрощенная схема сетевой части выглядит так</p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/toto1-ea5872efbee249035f89018fdbc88a2a.png" width="531" height="489" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Пояснения к картинке</div><div class="admonitionContent_S0QG"><p>На самом деле на поезде 4 РРС с разной поляризацией (две смотрят вперед и две назад). Внутри "поезда" наша славный роутер, который переключает ППТра. CGW-база - "наземный" сервер в диспетчерской, который собственно и является шлюзом в Интернет, а также потребителем трафика с камер поезда.</p><p>Для тестирования качественных показателей используются приборы BERcut-ETX и трафик-генератор T-Rex с различными профилями, что позволяет на разных моделях трафика оценить  количество потерь при переключении ППТра.</p></div></div><p>Вот настоящая схема с генератором трафика T-REX.
<img loading="lazy" alt="Alt text" src="/en/assets/images/toto2-6d9778a89946c502a1366e671f8a0cd1.png" width="610" height="436" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Пояснения к cхеме</div><div class="admonitionContent_S0QG"><p>На подвижном маршрутизаторе (TTR) - реализован демон  маршрутизации с нашим алгоритмом переключения ППТра. Алгоритм разработан с использованием DPDK на ОС Linux.</p><p>На стационарном сервере или как мы говорим "на базе" (CGW) - программная реализация, генерирующего потока heart-beat,  с нашем же алгоритмом переключения ППТра, разработанным с использование DPDK на ОС Linux</p></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Почему просто не взять коммерческий шлюз или Linux-маршрутизатор</div><div class="admonitionContent_S0QG"><p>Беда стандартных протоколов в том, что переключения  маршрута  в рамках обозначенных требований  очень медленное (даже на мощных сетевых маршрутизаторах), а если мы начинаем пользоваться IP-стеком Linux, то получаем снижение скорости при интенсивном роутинге 10Гбит и (что важнее) также переключение в районе 50мс, что для нас медленно. Для любой стационарной сети это хорошее время переключения (мы используем протокол <strong>BABEL</strong> для <strong>Mesh</strong> сетей), но мы предположили,  что при использовании DPDK это время можно кардинально уменьшить.</p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Материалы, что же такое DPDK и почему он быстрее обычного сетевого стека</div><div class="admonitionContent_S0QG"><ul><li><a href="https://habr.com/ru/companies/selectel/articles/313150/" target="_blank" rel="noopener noreferrer">Статья по DPDK на Habr #1</a></li><li><a href="https://habr.com/ru/companies/intel/articles/302126/" target="_blank" rel="noopener noreferrer">Статья по DPDK на Habr #2</a></li></ul></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Почему DPDK, а не VPP + DPDK  или OpenVSwitch + DPDK?</div><div class="admonitionContent_S0QG"><ul><li>В рамках поставленной задачи решили взять фреймворк с наилучшими в индустрии характеристиками работы с сетевыми контроллерами и исключить издержки OS.</li><li>Логика управления путями трафика не опирается на штатные механизмы рутинга на L2\L3 с использованием и сопровождением различного сорта таблиц а-ля ARP и\или рутинговых.</li><li>Функционал DPDK минимален и достаточен для реализации необходимой логики при минимальных издержках, которые могли бы быть привнесены программными слоями сверху DPDK.</li></ul></div></div><p>Наша задача - обеспечить непрерывный и полно-дуплексный поток данных 10Гбит/c, переключая маршрутизацию от базовой станции "впереди" к базовой станции "сзади" и обратно.</p><p>То есть, говоря сетевым языком нам надо переключать маршрут (на L2 или L3)  потока 10Гбит примерно раз в 5-10 секунд максимально быстро (с минимальными потерями). Интервал определяется скоростью движения поезда и интервалом между наземными РРС.</p><p>В этом проекте мы применяем программный фреймворк DPDK и мощную платформу NXP LX2160. Мы разработали
свой протокол, которые оптимизирован исключительно на эту задачу (с минимальными задержками переключает ППТра) .  Мы разработали свою собственную логику управления переключениями ППТра-ми . При этом
мы получаем скорость переключения ППТра  районе 1-10мс (миллисекунд), на лабораторном стенде.</p><p>💥 FleaPath - наше название, потому что трафик скачит как блоха...</p><p>💥 Еще один термин - <strong>heartbeat</strong>, <strong>хёрт-бит</strong> или <strong>HBT</strong>. Служебный трафик для определения "живости" маршрута с минимальной длиной пакета и максимальной частотой генерации пакетов.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="что-получилось">Что получилось<a href="#что-получилось" class="hash-link" aria-label="Direct link to Что получилось" title="Direct link to Что получилось">​</a></h2><p>В общем случае, при интервале HBT в 5000 микросекунд (5 миллисекунд) удаётся получить переключение исходящего ППТР-а в пределах 7000-10000 микросекунд (7-10 миллисекунд). При интервале 1 мс, мы получаем переключение в районе 1,5-3 мс, что является рекордным результатом на настоящем историческом этапе.  Разумеется эта цифра получена в условиях лабораторного стенда, но тем не менее наш стенд максимально физически приближен к натуральному воплощению.</p><p>Меньше интервал рассылки HBT - выше реактивность в петле обратной связи, а значит большая фоновая нагрузка на сетевую инфраструктуру служебным трафиком. Однако при интервале HBT в 1000 микросекунд (1 миллисекунду), ширина канала пропускного трафика примерно 1Мбит\с, что при общей полосе 10Гбит\с является допустимым в рамках начальных требований.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>А есть ли потери (все равно скажут, что потери есть) ?</div><div class="admonitionContent_S0QG"><p>О потерях. В стендовых испытаниях были диагностированы потери трафика, связанные, как понятно - с тем, что какое-то время ТТР отправлял фреймы по ППТра в никуда (до переключения на "живой" ППТра), в том смысле что связи между парой РРС  не было. Сколько пакетов, сколько трафика в объёме, может быть оценочно высчитано, исходя из интервала HBT и таймаута переключения. Прорабатывается несколько вариантов для повышения надёжности передачи по ППТра, исследования не закончены.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="стенды-и-проверка-работы">Стенды и проверка работы<a href="#стенды-и-проверка-работы" class="hash-link" aria-label="Direct link to Стенды и проверка работы" title="Direct link to Стенды и проверка работы">​</a></h2><p>Для проверки и тестирования мы собрали несколько стендов, один из которых представляет их себя полное физическое воплощение радиорелейной сети с регулируемым затуханием сигнала. Программа тестирования управляет электронными аттенюаторами затухания  в радиорелейной части, обеспечивая полную эмуляцию движения поезда вдоль меняющихся "базовых" станций.</p><p>Радио-релейная часть стенда</p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/stand1-b66c96d21d704f6ecae3b4fe6e1f0ec7.png" width="279" height="272" class="img_ev3q"></p><p>Кроме того, для проверки влияния потерь пакетов была собрана сеть из видеокамер, а также генератор трафика T-Rex с профилем "смешанный трафик". Таким образом, мы эмулируем пользователей в интернете в поезде (микс из youtube, веб, видео-общения, скачиваний файлов). Также мы провели испытания, пересаживая весь наш отдел на "поезд".</p><p>Надо с гордостью заявить, что первичными результатами мы воодушевлены. Мы не имеем заметных потерь и снижения скорости. При генерации T-Rex 10гбит смешанного трафика в поезде, наш DPDK-роутер "протаскивает" через себя весь трафик. Базисные принципы концепции были подтверждены, и мы готовимся к воплощению нашего решения в реальных условиях.</p><p><img loading="lazy" alt="Alt text" src="/en/assets/images/trex-1-3ba706eb35014f4e16b09148bc14fffe.png" width="982" height="646" class="img_ev3q"></p><p>При натуральных испытаниях в офисе мы занимали полосу примерно 3 Гбит\с трафика в пике и вообще не ощущали дискомфорта в работе.</p><p>...статья пилится...</p>]]></content:encoded>
            <category>team</category>
            <category>lab240</category>
        </item>
        <item>
            <title><![CDATA[First post]]></title>
            <link>https://lab240.github.io/en/blog/dmn-init</link>
            <guid>https://lab240.github.io/en/blog/dmn-init</guid>
            <pubDate>Wed, 12 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Зачем этот сайт ?]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="зачем-этот-сайт-">Зачем этот сайт ?<a href="#зачем-этот-сайт-" class="hash-link" aria-label="Direct link to Зачем этот сайт ?" title="Direct link to Зачем этот сайт ?">​</a></h2><ul><li>Привлечь новых соратников в комьюнити</li><li>В фривольной форме вести блог из которого потом готовить статьи</li><li>Дать возможность участникам генерить свой контент</li><li>Делиться радостями и печалями с сообществом</li></ul><p>:wq</p>]]></content:encoded>
            <category>team</category>
            <category>lab240</category>
        </item>
    </channel>
</rss>